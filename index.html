<!DOCTYPE html>
<html>

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.17.1/matter.min.js"></script>
    <script>
        function Start() {
            /*** CLASS DEFINITIONS ***/
            class Entity {
                constructor(pos, rot, parent) {
                    this.position = pos;
                    this.rotation = rot;
                    this.parent = parent;
                    this.children = [];
                    if (parent != null)
                        parent.children.push(this);
                }

                render(ctx) {
                    this.renderThis(ctx);

                    for (let i = 0; i < this.children.length; i++) {
                        const child = this.children[i];
                        child.render(ctx);
                    }
                }

                renderThis(ctx) {
                    // Derived class defines this method
                }

                update(keysDown, dt) {
                    this.updateThis(keysDown, dt);

                    for (let i = 0; i < this.children.length; i++) {
                        const child = this.children[i];
                        child.update(keysDown, dt);
                    }
                }

                updateThis(keysdown, dt) {
                    // Derived class defines this method
                }
            }

            class Tank extends Entity {
                constructor(ss, ssData) {
                    super({ x: 300, y: 300 }, 43, null);
                    this.body = Bodies.rectangle(this.position.x, this.position.y, 270, 111, {
                        isStatic: false
                    });

                    // Variables used for rendering this object
                    this.index = 0;
                    this.framesPerSecond = framesPerSecond;
                    this.timeTracker = 0;
                    this.spriteSheetData = ssData;
                    this.spriteSheet = ss;
                }

                updateThis(keysDown, dt) {
                    // Forward/backward
                    if (keysDown && keysDown.ArrowUp == true) {
                        Body.applyForce(
                            this.body, { x: this.body.position.x, y: this.body.position.y }, { x: 0, y: 0.05 }
                        );
                    }
                    if (keysDown && keysDown.ArrowDown == true) {
                        Body.applyForce(
                            this.body, { x: this.body.position.x, y: this.body.position.y }, { x: 0, y: -0.05 }
                        );
                    }

                    // Right/left
                    if (keysDown && keysDown.ArrowRight == true) {
                        this.rotation += this.rotationVelocity * dt;
                    }
                    if (keysDown && keysDown.ArrowLeft == true) {
                        this.rotation -= this.rotationVelocity * dt;
                    }

                    // Update index
                    this.timeTracker += dt;
                    let delay = 1 / this.framesPerSecond;
                    if (this.timeTracker >= delay) {
                        this.index += 1;
                        this.index = this.index % this.spriteSheetData.frames.length;
                        this.timeTracker = 0;
                    }
                }

                renderThis(ctx) {
                    ctx.drawImage(
                        this.spriteSheet,
                        this.spriteSheetData.frames[this.index].frame.x,
                        this.spriteSheetData.frames[this.index].frame.y,
                        this.spriteSheetData.frames[this.index].frame.w,
                        this.spriteSheetData.frames[this.index].frame.h,
                        this.body.position.x,
                        this.body.position.y,
                        this.spriteSheetData.frames[this.index].frame.w,
                        this.spriteSheetData.frames[this.index].frame.h
                    );
                }
            }

            // Globals
            window.globals = {};
            window.globals.canvas = document.getElementById("canvas");
            window.globals.context = window.globals.canvas.getContext("2d");

            // Physics APIs (aliases)
            var Engine = Matter.Engine;         // For updating physics.
            var Render = Matter.Render;         // For rendering results of Engine.
            var Bodies = Matter.Bodies;         // To use a pre-made Body.
            var Composite = Matter.Composite;   // Container for entity made of multiple parts.
            var Body = Matter.Body;             // To make a custom Body.
            var Runner = Matter.Runner;         // Optional game loop (Auto updates Engine).
            var World = Matter.World;

            // Set canvas size
            window.globals.canvas.width = window.innerWidth;
            window.globals.canvas.height = window.innerHeight;

            // Create a physics engine
            var engine = Engine.create();

            // Create a renderer
            var render = Render.create({
                canvas: window.globals.canvas,
                engine: engine,
                options: {
                    wireframes: false
                }
            });
            // Start the renderer
            Render.run(render);

            // Create entities
            var test = Bodies.rectangle(200, 300, 200, 200);
            var ground = Bodies.rectangle(400, 610, 810, 60, { isStatic: true });

            Composite.add(engine.world, [ground, test]);

            /*** Game Loop ***/
            (function gameLoop(timeStamp) {
                // Run Game Loop every frame
                window.requestAnimationFrame(gameLoop);

                // Update physics
                Engine.update(engine, 1000 / 60);
            })();
        }
    </script>
</head>

<body onload="Start()">
    <div id="canvas-div">
        <canvas id="canvas" width="1000" height="1000" style="position: absolute; z-index: 0;"></canvas>
    </div>
</body>

</html>